<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala VPU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" type="module"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-center">Sistema de Escalas</h1>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-6xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Calend√°rio -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <!-- Controles do Calend√°rio -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="prevMonth"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ‚Üê Anterior
                        </button>
                        <h2 id="currentMonth" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
                        <button id="nextMonth"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            Pr√≥ximo ‚Üí
                        </button>
                    </div>

                    <!-- Grid do Calend√°rio -->
                    <div class="grid grid-cols-7 gap-1 mb-4">
                        <!-- Cabe√ßalho dos dias da semana -->
                        <div class="text-center font-bold p-2 text-gray-600">Dom</div>
                        <div class="text-center font-bold p-2 text-gray-600">Seg</div>
                        <div class="text-center font-bold p-2 text-gray-600">Ter</div>
                        <div class="text-center font-bold p-2 text-gray-600">Qua</div>
                        <div class="text-center font-bold p-2 text-gray-600">Qui</div>
                        <div class="text-center font-bold p-2 text-gray-600">Sex</div>
                        <div class="text-center font-bold p-2 text-gray-600">S√°b</div>
                    </div>

                    <!-- Dias do calend√°rio -->
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                        <!-- Os dias ser√£o gerados dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Painel Lateral -->
            <div class="space-y-6">
                <!-- Pr√≥ximas Escalas -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìÖ Pr√≥ximas Escalas</h3>
                    <div id="upcomingSchedules" class="space-y-3">
                        <!-- As pr√≥ximas escalas ser√£o carregadas aqui -->
                    </div>
                </div>

                <!-- Status de Conex√£o -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Status</h3>
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Conectando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gerenciar Escalas -->
    <div id="scheduleModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>

                <!-- Lista de Funcion√°rios Escalados -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Funcion√°rios Escalados:</h4>
                    <div id="scheduledEmployees" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                        <!-- Funcion√°rios ser√£o listados aqui -->
                    </div>
                </div>

                <!-- Adicionar Funcion√°rio -->
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-3">Adicionar Funcion√°rio:</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="employeeName" placeholder="Nome do funcion√°rio"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="addEmployee"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            Adicionar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip"
        class="fixed bg-gray-800 text-white text-sm px-3 py-2 rounded-lg shadow-lg pointer-events-none z-50 tooltip">
        <div id="tooltipContent"></div>
    </div>

    <script type="module">
        // Configura√ß√£o do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            query,
            where,
            getDocs,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Configura√ß√£o do Firebase (substitua pelas suas credenciais)
        const firebaseConfig = {
            apiKey: "AIzaSyAZkqhpI65wReHGsp5s6DxZhhmHjAmAeIA",
            authDomain: "escala-vpu.firebaseapp.com",
            projectId: "escala-vpu",
            storageBucket: "escala-vpu.firebasestorage.app",
            messagingSenderId: "514143628923",
            appId: "1:514143628923:web:bc29094ad9915f5c917cde"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado da aplica√ß√£o
        let currentDate = new Date();
        let selectedDate = null;
        let schedules = new Map();

        // Elementos do DOM
        const elements = {
            prevMonth: document.getElementById('prevMonth'),
            nextMonth: document.getElementById('nextMonth'),
            currentMonth: document.getElementById('currentMonth'),
            calendarGrid: document.getElementById('calendarGrid'),
            scheduleModal: document.getElementById('scheduleModal'),
            closeModal: document.getElementById('closeModal'),
            modalTitle: document.getElementById('modalTitle'),
            scheduledEmployees: document.getElementById('scheduledEmployees'),
            employeeName: document.getElementById('employeeName'),
            addEmployee: document.getElementById('addEmployee'),
            upcomingSchedules: document.getElementById('upcomingSchedules'),
            connectionStatus: document.getElementById('connectionStatus'),
            tooltip: document.getElementById('tooltip'),
            tooltipContent: document.getElementById('tooltipContent')
        };

        // Utilit√°rios
        const utils = {
            formatDate(date) {
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            },

            formatDateKey(date) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            },

            parseDateKey(dateKey) {
                const [year, month, day] = dateKey.split('-').map(Number);
                return new Date(year, month - 1, day);
            },

            getMonthName(date) {
                const months = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Juli', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                return `${months[date.getMonth()]} ${date.getFullYear()}`;
            }
        };

        // Gerenciador do Firebase
        const firebaseManager = {
            async updateConnectionStatus(status, message) {
                const statusEl = elements.connectionStatus;
                const dot = statusEl.querySelector('div');
                const text = statusEl.querySelector('span');

                if (status === 'connected') {
                    dot.className = 'w-3 h-3 bg-green-400 rounded-full';
                    text.textContent = message || 'Conectado';
                } else if (status === 'error') {
                    dot.className = 'w-3 h-3 bg-red-400 rounded-full';
                    text.textContent = message || 'Erro de conex√£o';
                } else {
                    dot.className = 'w-3 h-3 bg-yellow-400 rounded-full';
                    text.textContent = message || 'Conectando...';
                }
            },

            async saveSchedule(dateKey, employees) {
                try {
                    await this.updateConnectionStatus('connecting', 'Salvando...');
                    const docRef = doc(db, 'schedules', dateKey);
                    await setDoc(docRef, { employees, date: dateKey });
                    schedules.set(dateKey, employees);
                    await this.updateConnectionStatus('connected', 'Salvo com sucesso');
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar escala:', error);
                    await this.updateConnectionStatus('error', 'Erro ao salvar');
                    // Simular salvamento local para demonstra√ß√£o
                    schedules.set(dateKey, employees);
                    return false;
                }
            },

            async loadSchedule(dateKey) {
                try {
                    const docRef = doc(db, 'schedules', dateKey);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        schedules.set(dateKey, data.employees || []);
                        return data.employees || [];
                    }
                    return [];
                } catch (error) {
                    console.error('Erro ao carregar escala:', error);
                    return schedules.get(dateKey) || [];
                }
            },

            async loadMonthSchedules(year, month) {
                try {
                    await this.updateConnectionStatus('connecting', 'Carregando...');
                    const monthKey = `${year}-${month.toString().padStart(2, '0')}`;

                    // Para demonstra√ß√£o, vamos simular alguns dados
                    const sampleData = new Map();
                    const today = new Date();

                    sampleData.forEach((employees, dateKey) => {
                        schedules.set(dateKey, employees);
                    });

                    await this.updateConnectionStatus('connected', 'Dados carregados');
                    return sampleData;
                } catch (error) {
                    console.error('Erro ao carregar escalas do m√™s:', error);
                    await this.updateConnectionStatus('error', 'Erro ao carregar');
                    return new Map();
                }
            }
        };

        // Gerenciador do Calend√°rio
        const calendar = {
            async render() {
                elements.currentMonth.textContent = utils.getMonthName(currentDate);

                // Carregar escalas do m√™s
                await firebaseManager.loadMonthSchedules(currentDate.getFullYear(), currentDate.getMonth() + 1);

                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                elements.calendarGrid.innerHTML = '';

                let currentDay = new Date(startDate);
                const today = new Date();

                for (let week = 0; week < 6; week++) {
                    let hasValidDay = false;
                    const weekDays = [];

                    for (let day = 0; day < 7; day++) {
                        if (currentDay.getMonth() === currentDate.getMonth()) {
                            hasValidDay = true;
                        }
                        weekDays.push(new Date(currentDay));
                        currentDay.setDate(currentDay.getDate() + 1);
                    }

                    if (!hasValidDay && week > 0) break;

                    weekDays.forEach(dayDate => {
                        const dayEl = this.createDayElement(dayDate, today);
                        elements.calendarGrid.appendChild(dayEl);
                    });
                }

                this.updateUpcomingSchedules();
            },

            createDayElement(dayDate, today) {
                const dayEl = document.createElement('div');
                const isCurrentMonth = dayDate.getMonth() === currentDate.getMonth();
                const isToday = dayDate.toDateString() === today.toDateString();
                const dateKey = utils.formatDateKey(dayDate);
                const daySchedules = schedules.get(dateKey) || [];

                dayEl.className = `
                    day-cell min-h-[80px] p-2 border border-gray-200 cursor-pointer transition-colors relative
                    ${isCurrentMonth ? 'bg-white hover:bg-blue-50' : 'bg-gray-50 text-gray-400'}
                    ${isToday ? 'ring-2 ring-blue-500' : ''}
                    ${daySchedules.length > 0 ? 'bg-green-50 border-green-200' : ''}
                `;

                dayEl.innerHTML = `
                    <div class="font-semibold text-sm mb-1">${dayDate.getDate()}</div>
                    <div class="text-xs space-y-1">
                        ${daySchedules.slice(0, 2).map(emp =>
                    `<div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs truncate">${emp}</div>`
                ).join('')}
                        ${daySchedules.length > 2 ?
                        `<div class="text-gray-500 text-xs">+${daySchedules.length - 2} mais</div>` : ''
                    }
                    </div>
                `;

                if (isCurrentMonth) {
                    dayEl.addEventListener('click', () => this.openScheduleModal(dayDate));
                }

                // Tooltip
                if (daySchedules.length > 0) {
                    dayEl.addEventListener('mouseenter', (e) => this.showTooltip(e, daySchedules));
                    dayEl.addEventListener('mouseleave', () => this.hideTooltip());
                }

                return dayEl;
            },

            showTooltip(e, employees) {
                elements.tooltipContent.innerHTML = `
                    <div class="font-semibold mb-1">Escalados:</div>
                    ${employees.map(emp => `<div>‚Ä¢ ${emp}</div>`).join('')}
                `;

                elements.tooltip.style.left = e.pageX + 10 + 'px';
                elements.tooltip.style.top = e.pageY - 10 + 'px';
                elements.tooltip.classList.add('show');
            },

            hideTooltip() {
                elements.tooltip.classList.remove('show');
            },

            openScheduleModal(date) {
                selectedDate = date;
                const dateKey = utils.formatDateKey(date);
                const daySchedules = schedules.get(dateKey) || [];

                elements.modalTitle.textContent = `Escala - ${utils.formatDate(date)}`;
                this.updateModalEmployees(daySchedules);
                elements.scheduleModal.classList.remove('hidden');
                elements.employeeName.focus();
            },

            updateModalEmployees(employees) {
                elements.scheduledEmployees.innerHTML = employees.length > 0
                    ? employees.map(emp => `
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                            <span class="font-medium">${emp}</span>
                            <button onclick="calendar.removeEmployee('${emp}')" 
                                    class="text-red-500 hover:text-red-700 font-bold">√ó</button>
                        </div>
                    `).join('')
                    : '<p class="text-gray-500 text-center py-4">Nenhum funcion√°rio escalado</p>';
            },

            async addEmployee() {
                const name = elements.employeeName.value.trim();
                if (!name || !selectedDate) return;

                const dateKey = utils.formatDateKey(selectedDate);
                const currentEmployees = schedules.get(dateKey) || [];

                if (currentEmployees.includes(name)) {
                    alert('Funcion√°rio j√° escalado para este dia!');
                    return;
                }

                const updatedEmployees = [...currentEmployees, name];
                await firebaseManager.saveSchedule(dateKey, updatedEmployees);

                this.updateModalEmployees(updatedEmployees);
                this.render();
                elements.employeeName.value = '';
            },

            async removeEmployee(name) {
                if (!selectedDate) return;

                const dateKey = utils.formatDateKey(selectedDate);
                const currentEmployees = schedules.get(dateKey) || [];
                const updatedEmployees = currentEmployees.filter(emp => emp !== name);

                await firebaseManager.saveSchedule(dateKey, updatedEmployees);
                this.updateModalEmployees(updatedEmployees);
                this.render();
            },

            updateUpcomingSchedules() {
                const today = new Date();
                const upcoming = [];

                schedules.forEach((employees, dateKey) => {
                    const date = utils.parseDateKey(dateKey);
                    if (date >= today && employees.length > 0) {
                        upcoming.push({ date, employees, dateKey });
                    }
                });

                upcoming.sort((a, b) => a.date - b.date);

                elements.upcomingSchedules.innerHTML = upcoming.slice(0, 5).length > 0
                    ? upcoming.slice(0, 5).map(item => `
                        <div class="border-l-4 border-blue-400 pl-4 py-2">
                            <div class="font-semibold text-sm text-gray-800">${utils.formatDate(item.date)}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                ${item.employees.join(', ')}
                            </div>
                        </div>
                    `).join('')
                    : '<p class="text-gray-500 text-sm text-center py-4">Nenhuma escala pr√≥xima</p>';
            }
        };

        // Event Listeners
        elements.prevMonth.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            await calendar.render();
        });

        elements.nextMonth.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            await calendar.render();
        });

        elements.closeModal.addEventListener('click', () => {
            elements.scheduleModal.classList.add('hidden');
        });

        elements.scheduleModal.addEventListener('click', (e) => {
            if (e.target === elements.scheduleModal) {
                elements.scheduleModal.classList.add('hidden');
            }
        });

        elements.addEmployee.addEventListener('click', () => calendar.addEmployee());

        elements.employeeName.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                calendar.addEmployee();
            }
        });

        // Tornar fun√ß√£o dispon√≠vel globalmente para o onclick
        window.calendar = calendar;

        // Inicializar aplica√ß√£o
        async function init() {
            await firebaseManager.updateConnectionStatus('connecting', 'Inicializando...');
            await calendar.render();

            // Simular conex√£o com Firebase
            setTimeout(async () => {
                await firebaseManager.updateConnectionStatus('connected', 'Sistema pronto');
            }, 1000);
        }

        init();
    </script>
</body>

</html>